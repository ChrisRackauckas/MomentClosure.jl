<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>LMA Example · MomentClosure.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://augustinas1.github.io/MomentClosure.jl/tutorials/LMA_example/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MomentClosure.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../../theory/moment_expansion/">Moment Expansion</a></li><li><a class="tocitem" href="../../theory/moment_closure_approximations/">Moment Closure Approximations</a></li><li><a class="tocitem" href="../../theory/linear_mapping_approximation/">Linear Mapping Approximation</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../using_momentclosure/">Using MomentClosure</a></li><li><a class="tocitem" href="../common_issues/">Common Issues</a></li><li><a class="tocitem" href="../time-dependent_propensities/">Time-dependent propensity functions</a></li><li><a class="tocitem" href="../geometric_reactions+conditional_closures/">Geometrically Distributed Reaction Products and Conditional Closures</a></li><li><a class="tocitem" href="../P53_system_example/">P53 System Example</a></li><li><a class="tocitem" href="../derivative_matching_example/">Derivative Matching Example</a></li><li><a class="tocitem" href="../SIR_example/">SIR Model Example</a></li><li class="is-active"><a class="tocitem" href>LMA Example</a><ul class="internal"><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api/momentclosure_api/">MomentClosure.jl API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>LMA Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>LMA Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/augustinas1/MomentClosure.jl/blob/master/docs/src/tutorials/LMA_example.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="linear_mapping_approximation_example"><a class="docs-heading-anchor" href="#linear_mapping_approximation_example">LMA Example</a><a id="linear_mapping_approximation_example-1"></a><a class="docs-heading-anchor-permalink" href="#linear_mapping_approximation_example" title="Permalink"></a></h1><p>In this example, we demonstrate how the <a href="../../theory/linear_mapping_approximation/#linear_mapping_approximation">Linear Mapping Approximation (LMA)</a> can be applied on chemical reaction networks using MomentClosure. We illustrate the approach on models of a simple nonlinear feedback loop and a genetic toggle switch, in turn reproducing some of the results published in the original <a href="../../theory/linear_mapping_approximation/#linear_mapping_approximation">LMA</a> paper by Cao and Grima [1].</p><p>We start by considering a simple nonlinear gene regulatory network (GRN) shown in the diagram below (adapted from [1]):</p><img src="../assets/nonlinear_genetic_feedback_loop_scheme.png" width="50%"/>⠀<p>Here we have a two-state gene promoter which can be in either state <span>$G$</span> or <span>$G^*$</span>. As in a <a href="../geometric_reactions+conditional_closures/#geometric-and-conditional">previous example tutorial</a>, we interpret the gene as a distinct species modelled as a Bernoulli variable <span>$g$</span>, associating the states <span>$G$</span> and <span>$G^*$</span> with the values <span>$g=1$</span> and <span>$g=0$</span> respectively. Protein <span>$P$</span> is produced from both gene states <span>$G$</span> and <span>$G^*$</span> (with different rates <span>$ρ_u$</span> and <span>$ρ_b$</span>) and can subsequently decay. The switch between <span>$G$</span> and <span>$G^*$</span> (or the feedback) is introduced via protein binding to the gene in state <span>$G$</span>.</p><p>First step in applying the LMA is to transform this nonlinear gene regulatory network (GRN) into a linear GRN. This can be done by removing the second-order reaction between <span>$P$</span> and <span>$G$</span>, so that the reversible reaction <span>$G+P \underset{σ_u}{\stackrel{σ_b}{\rightleftharpoons}} G^*$</span> is replaced by <span>$G \underset{σ_u}{\stackrel{\bar{σ}_b}{\rightleftharpoons}} G^*$</span>. This equivalent linear GRN can be visualised as (adapted from [1]):</p><img src="../assets/linear_genetic_feedback_loop_scheme.png" width="50%"/>⠀<p>Note that MomentClosure cannot automate this linearisation step as the choice of how the other reactions in the network are changed due to the removal of nonlinear reactions is arbitrary. For this reason, we define both nonlinear and linear GRNs using Catalyst as follows:</p><pre><code class="language-julia hljs">using Catalyst

# NOTE: both models MUST preserve the same ordering of reactions in order to detect
# how the nonlinear reactions are to be transformed using LMA

rn_nonlinear = @reaction_network begin
      σ_b, g + p → 0
      σ_u*(1-g), 0 ⇒ g + p
      ρ_u, g → g + p
      ρ_b*(1-g), 0 ⇒ p
      1, p → 0
end σ_b σ_u ρ_b ρ_u

rn_linear = @reaction_network begin
      σ_b_LMA, g → 0      # typing ̄σ_b is not allowed it seems
      σ_u*(1-g), 0 ⇒ g
      ρ_u, g → g+p
      (ρ_b*(1-g)), 0 ⇒ p
      1, p → 0
end σ_b_LMA σ_u ρ_b ρ_u</code></pre><p>We can now apply the LMA to find the effective parameter <span>$\bar{σ}_b$</span> and generate the corresponding moment equations of the linear GRN using MomentClosure&#39;s <a href="../../api/momentclosure_api/#MomentClosure.linear_mapping_approximation"><code>linear_mapping_approximation</code></a>:</p><pre><code class="language-julia hljs"># NOTE: we have to provide the indices of binary variables in the system as they are ordered in the *nonlinear* GRN.
# The distinction here between linear and nonlinear GRNs is important as in some cases the internal ordering of variables of the two Catalyst models can differ
@parameters t
@variables g(t)
binary_vars = [speciesmap(rn_nonlinear)[g]]

LMA_eqs, effective_params = linear_mapping_approximation(rn_nonlinear, rn_linear, binary_vars, combinatoric_ratelaw=false)
display(effective_params)</code></pre><pre><code class="language-julia hljs">
OrderedDict{Any, Any} with 1 entry:
  σ_b_LMA =&gt; σ_b*μ₁₁(t)*(μ₁₀(t)^-1)</code></pre><p>We can also print out the moment equations:</p><pre><code class="language-julia hljs">using Latexify
latexify(LMA_eqs)</code></pre><p class="math-container">\[\begin{align*}
\frac{d\mu{_{10}}}{dt} =&amp; \sigma_{u} - \sigma_{b} \mu{_{11}} - \sigma_{u} \mu{_{10}} \\
\frac{d\mu{_{01}}}{dt} =&amp; \rho_{b} + \rho_{u} \mu{_{10}} - \mu{_{01}} - \rho_{b} \mu{_{10}} \\
\frac{d\mu{_{11}}}{dt} =&amp; \rho_{u} \mu{_{10}} + \sigma_{u} \mu{_{01}} - \mu{_{11}} - \sigma_{u} \mu{_{11}} - \sigma_{b} \mu{_{10}}^{-1} \mu{_{11}}^{2} \\
\frac{d\mu{_{02}}}{dt} =&amp; \rho_{b} + \rho_{u} \mu{_{10}} + 2 \rho_{b} \mu{_{01}} + 2 \rho_{u} \mu{_{11}} + \mu{_{01}} - 2 \mu{_{02}} - \rho_{b} \mu{_{10}} - 2 \rho_{b} \mu{_{11}}
\end{align*}\]</p><p>Note that the results agree with Eqs. (1) and (2) in <a href="tutorials/after the corresponding substitution">1</a>. The moment equations are already closed, so we can solve them numerically and plot the mean protein number over time:</p><pre><code class="language-julia hljs">using OrdinaryDiffEq, Sundials

# [g, p] as in `species(rn_nonlinear)`
u₀ = [1.0, 0.001]
p = [0.004, 0.25, 25.0, 60.0]
tspan = (0., 15.)
dt = 0.1

u₀map = deterministic_IC(u₀, LMA_eqs)
oprob_LMA = ODEProblem(LMA_eqs, u₀map, tspan, p)
sol_LMA = solve(oprob_LMA, CVODE_BDF(), saveat=dt)

plot(sol_LMA, vars=(0, [2]), label=&quot;LMA&quot;, ylabel=&quot;⟨p⟩&quot;, xlabel=&quot;time&quot;, fmt=&quot;svg&quot;)</code></pre><p><img src="../../assets/LMA_feedback_loop_mean_protein_number.svg" alt="LMA feedback loop mean protein number"/></p><p>To compare the LMA result to the true moment dynamics we use the Finite State Projection (FSP) algorithm implemented in <a href="https://github.com/kaandocal/FiniteStateProjection.jl">FiniteStateProjection.jl</a>. FSP can be much more efficient than SSA in accurately approximating the full time-dependent probability distribution of the given chemical system when the system&#39;s state space is small (hence it is particularly effective for the nonlinear GRN here). Having obtained the FSP solution, we can extract the time-evolution of moments using <a href="../../api/momentclosure_api/#MomentClosure.get_moments_FSP"><code>get_moments_FSP</code></a> function and finally compare them to the LMA predictions. This can all be done as follows:</p><pre><code class="language-julia hljs">using FiniteStateProjection

fsp_sys = FSPSystem(rn_nonlinear, combinatoric_ratelaw=false)
# Truncate the state space of the system
# The gene has two states (G or G*) whereas we consider protein number from 0 to 100
state_space = [2, 101]

# The initial condition is the matrix of probabilities representing the state of the system
# We assume zero protein and the gene to be in the state G, hence the probability of this
# specific state should be set to 1 initially
u0 = zeros(state_space...)
u0[2, 1] = 1.0

# construct an ODE problem from the FSPSystem and solve it
fsp_prob = ODEProblem(fsp_sys, u0, tspan, p)
sol_FSP = solve(fsp_prob, CVODE_BDF(), saveat=dt)

# extract the 1st order raw moments from the FSP solution
μ_FSP = get_moments_FSP(sol_FSP, 1, &quot;raw&quot;)
plot!(sol_FSP.t, μ_FSP[(0,1)], label=&quot;FSP&quot;, legend=:bottomright)</code></pre><p><img src="../../assets/LMA+FSP_feedback_loop_mean_protein_number.svg" alt="LMA and FSP feedback loop mean protein number"/></p><p>Using the LMA as implemented in MomentClosure, we can generate and solve the closed moment equations for any LMA-suitable nonlinear chemical reaction network, given that its linear equivalent is also provided. Proceeding further to obtain an approximate time-dependent probability distribution of the nonlinear network is more involved as only a handful of closed-form solutions of linear networks are known. Moreover, simply computing the solutions can be a challenge due to their complicated analytical form. For these reasons, MomentClosure does not provide an automated approach to computing the probability distributions of the relevant nonlinear systems using LMA—these steps have to performed manually on a case-by-case basis. Nevertheless, below we demonstrate how this could be done for the nonlinear GRN we have been considering so far.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><p>[1]: Z. Cao and R. Grima, &quot;Linear mapping approximation of gene regulatory networks with stochastic dynamics&quot;, Nature Communications 9, 3305 (2018). <a href="https://doi.org/10.1038/s41467-018-05822-0">https://doi.org/10.1038/s41467-018-05822-0</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../SIR_example/">« SIR Model Example</a><a class="docs-footer-nextpage" href="../../api/momentclosure_api/">MomentClosure.jl API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.4 on <span class="colophon-date" title="Wednesday 21 July 2021 02:22">Wednesday 21 July 2021</span>. Using Julia version 1.6.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
